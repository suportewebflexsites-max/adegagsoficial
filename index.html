<script>
const WHATSAPP = "5511981654980";
const FREE_LIMIT = 120;
const storeLat = -23.6687;
const storeLng = -46.4613;
const PIX_KEY = "61.888.559/0001-94";

let cart = {};
let userLat = null;
let userLng = null;
let isAdult = null;

/* =========================
   CONTROLE DE IDADE
========================= */
document.body.insertAdjacentHTML("beforeend", `
<div id="ageModal" style="position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:5000;display:flex;align-items:center;justify-content:center">
  <div style="background:#111;padding:20px;border-radius:12px;max-width:320px;text-align:center">
    <h2>üîû Conte√∫do para maiores de 18 anos</h2>
    <p>Voc√™ confirma que √© maior de idade?</p>
    <button onclick="setAge(true)" style="width:100%;background:#2ecc71;padding:12px;border:none;border-radius:8px;margin-bottom:8px">SIM, sou maior</button>
    <button onclick="setAge(false)" style="width:100%;background:#444;padding:12px;border:none;border-radius:8px">N√ÉO</button>
  </div>
</div>
`);

function setAge(val){
  isAdult = val;
  document.getElementById("ageModal").remove();
  render();
}

/* =========================
   PRODUTOS
========================= */
const produtos = {
"Cervejas":[
["Amstel 269ml",9],["Heineken 269ml",5.2],["Original 269ml",4],["Skol 269ml",4],
["Brahma Duplo Malte 350ml",4.5],["Corona Long Neck",8],["Budweiser Long Neck",8],
["Budweiser Lata 269ml",9],["Spaten 269ml",4.5],["Cerveja Imp√©rio 210ml",6]
],
"Fardos":[
["Amstel c/12",34],["Heineken c/8",41.6],["Original c/8",32],
["Skol Beats Senses c/8",48],["Skol Beats Red Mix c/8",48],
["Skol Beats GT c/8",48],["Brahma Duplo Malte c/12",54],
["Budweiser c/8",56],["Skol c/15",56]
],
"Energ√©ticos":[
["Red Bull 250ml",10],["Baly Melancia 2L",10.5],["Baly Tropical 2L",12.35],
["Baly Ma√ß√£ Verde 2L",12.35],["Baly Morango e P√™ssego 2L",12.35],["Vibe 2L",11.6]
],
"Destilados":[
["Whisky White Horse 1L",99.99],["Whisky Ballantines 1L",99.99],
["Whisky Red Label 1L",99.99],["Gin Eternity 900ml",25.9],
["Smirnoff 1L",42.5],["Velho Barreiro 910ml",18],["Ice Smirnoff 275ml",8]
],
"Extras":[
["Gelo sabor Melancia",4.5],["Gelo sabor Coco",4.5],["Carv√£o",18],["Saco de Gelo",18]
]
};

function render(){
  const div = document.getElementById("products");
  div.innerHTML = "";

  for(let cat in produtos){
    if(!isAdult && (cat === "Cervejas" || cat === "Fardos" || cat === "Destilados")) continue;

    div.innerHTML += `<div class="category"><h2>${cat}</h2></div>`;
    produtos[cat].forEach(p=>{
      div.innerHTML += `
      <div class="product">
        <img src="https://via.placeholder.com/60">
        <div class="product-info">
          <span>${p[0]}</span><br>
          <strong>R$ ${p[1].toFixed(2)}</strong>
        </div>
        <button onclick="add('${p[0]}',${p[1]})">Adicionar</button>
      </div>`;
    });
  }
}

/* =========================
   CARRINHO
========================= */
function add(n,p){
  cart[n] ? cart[n].q++ : cart[n] = {p,q:1};
  update();
}

function update(){
  let total = 0, count = 0, html = "";
  for(let k in cart){
    total += cart[k].p * cart[k].q;
    count += cart[k].q;
    html += `${k} x${cart[k].q}<br>`;
  }
  document.getElementById("cartItems").innerHTML = html;
  document.getElementById("total").innerText = (total + calcFrete(total)).toFixed(2);
  document.getElementById("cartCount").innerText = count;
  updateFree(total);
}

/* =========================
   FRETE
========================= */
function calcFrete(total){
  if(!userLat) return 0;
  if(total >= FREE_LIMIT) return 0;

  const d = calcDist(userLat,userLng,storeLat,storeLng);

  if(d <= 3) return 5;
  if(d <= 5) return 8;
  if(d <= 8) return 12;
  if(d <= 12) return 16;
  if(d <= 15) return 18;
  return 18 + Math.ceil(d - 15) * 2;
}

function updateFree(total){
  const falta = FREE_LIMIT - total;
  const pct = Math.min(100,(total/FREE_LIMIT)*100);
  document.getElementById("freeBar").style.width = pct+"%";
  document.getElementById("freeText").innerText =
    falta > 0 ? `Faltam R$ ${falta.toFixed(2)} para frete gr√°tis` : "üéâ Frete gr√°tis garantido!";
}

/* =========================
   GPS
========================= */
navigator.geolocation.getCurrentPosition(p=>{
  userLat = p.coords.latitude;
  userLng = p.coords.longitude;
});

function calcDist(lat1,lon1,lat2,lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* =========================
   FINALIZAR
========================= */
function finalizar(){
  if(!userLat) return alert("Ative o GPS para calcular o frete");

  const pag = document.getElementById("pagamento").value;
  let msg = "Pedido realizado.\n";

  for(let k in cart) msg += `${k} x${cart[k].q}\n`;

  msg += `\nPagamento: ${pag}`;

  if(pag === "PIX"){
    msg += `\nPIX: ${PIX_KEY}`;
  } else {
    msg += `\nAp√≥s finalizar enviaremos o link de pagamento com o frete.`;
  }

  window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank");
}

function openCart(){document.getElementById("overlay").style.display="block"}
function closeCart(){document.getElementById("overlay").style.display="none"}
</script>
